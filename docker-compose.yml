version: '3.8'

services:
  whatsapp-bot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: eatcloud-whatsapp-bot
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
      - PORT=3000
      - EATCLOUD_BASE_URL=${EATCLOUD_BASE_URL}
      - SESSION_TTL_MINUTES=${SESSION_TTL_MINUTES}
      - DONATION_BASE_URL=${DONATION_BASE_URL}
      - DONATION_USERNAME=${DONATION_USERNAME}
      - DONATION_PASSWORD=${DONATION_PASSWORD}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    volumes:
      # Mount source code for hot-reload in development
      - ./server.js:/app/server.js
      - ./package.json:/app/package.json
      # Prevent node_modules from being overwritten
      - /app/node_modules
    depends_on:
      - redis
    restart: unless-stopped
    networks:
      - bot-network

  redis:
    image: redis:7-alpine
    container_name: eatcloud-redis
    ports:
      - "6379:6379"
    volumes:
      # Persist Redis data
      - redis-data:/data
    command: redis-server --appendonly yes
    restart: unless-stopped
    networks:
      - bot-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

volumes:
  redis-data:

networks:
  bot-network:
    driver: bridge